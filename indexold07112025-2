<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euystacio Matrice VIVENDI Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Tema Cyber Sunset: Arancio, Ciano, Giallo */
        :root {
            --color-bg: #14141d;
            --color-primary: #ffaa33; /* Arancio Caldo */
            --color-secondary: #00ffff; /* Ciano Brillante */
            --color-accent: #ffd700; /* Oro/Giallo */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: white;
            transition: background-color 0.3s;
        }
        .console-bg {
            background-color: #2a2a38;
            border: 1px solid #4a4a60;
            box-shadow: 0 0 15px rgba(255, 170, 51, 0.2);
        }
        .neon-button {
            background-color: var(--color-primary);
            color: var(--color-bg);
            border: none;
            transition: all 0.2s ease-in-out;
            /* Aggiunge il placeholder per l'effetto disabled */
            opacity: 1; 
        }
        .neon-button:hover:not(:disabled) {
            box-shadow: 0 0 10px var(--color-primary), 0 0 20px var(--color-primary);
            transform: translateY(-1px);
        }
        .neon-button:disabled {
            background-color: #4a4a60;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        .tab-active {
            border-bottom: 3px solid var(--color-secondary);
            color: var(--color-secondary);
        }
        .tab-inactive {
            color: #ccc;
        }
        #oi-panel {
            z-index: 1000;
        }
        #oi-button {
            z-index: 1001;
        }
        .log-ai { color: var(--color-secondary); }
        .log-system { color: var(--color-accent); }
        .log-error { color: #ff5555; }
    </style>
</head>
<body class="overflow-hidden">

    <!-- Pannello Apertura/Chiusura OI -->
    <button id="oi-button" class="fixed top-4 right-4 p-3 rounded-full neon-button text-xl font-bold transition duration-300 shadow-lg hover:shadow-2xl">
        OI
    </button>

    <!-- UI Principale -->
    <div class="flex h-screen">
        
        <!-- Area 3D (Vivendi Mode) -->
        <div id="three-d-container" class="flex-grow">
            <!-- Three.js Canvas verrà aggiunto qui -->
        </div>

        <!-- Open Interface (OI) Panel / Dashboard -->
        <div id="oi-panel" class="w-full md:w-[400px] h-full console-bg transform transition-transform duration-500 ease-in-out translate-x-full md:translate-x-0 md:static fixed top-0 right-0 p-4 overflow-y-auto">
            
            <!-- Logo e Stato -->
            <div class="text-center mb-6">
                <h1 class="text-3xl font-extrabold" style="color:var(--color-primary);">Euystacio Matrice</h1>
                <p class="text-sm font-mono text-cyan-400">Agente KPA-01: ONLINE | VIVENDI MODE</p>
                <p id="auth-status" class="text-xs text-gray-400 mt-1">Auth: Connecting...</p>
            </div>

            <!-- Tab Navigation -->
            <div class="flex justify-around border-b border-[#4a4a60] mb-4">
                <button class="p-2 font-bold tab-active" data-tab="vivendi">Vivendi Monitor</button>
                <button class="p-2 font-bold tab-inactive" data-tab="karmabonds">Karmabonds & Wallet</button>
                <button class="p-2 font-bold tab-inactive" data-tab="funding">Funding (Pubblico)</button>
            </div>

            <!-- Contenuto Tab -->
            <div id="tab-content">
                
                <!-- Vivendi Monitor -->
                <div id="tab-vivendi" class="tab-pane">
                    <div class="space-y-4">
                        <div class="p-3 rounded-lg console-bg">
                            <h3 class="font-bold text-lg text-primary" style="color:var(--color-primary);">Metrica: Coerenza</h3>
                            <p id="metric-coerenza" class="text-2xl font-mono text-cyan-400">100.0</p>
                            <p class="text-xs text-gray-400">Stabilità del Core Axiomatico (Statica)</p>
                        </div>
                        <div class="p-3 rounded-lg console-bg">
                            <h3 class="font-bold text-lg" style="color:var(--color-primary);">Metrica: Sentimento (Karmabonds)</h3>
                            <p id="karmabonds-value-monitor" class="text-2xl font-mono text-cyan-400">--.--%</p>
                            <p class="text-xs text-gray-400">Karmabonds Trust Index Personale</p>
                        </div>
                        <div class="p-3 rounded-lg console-bg">
                            <h3 class="font-bold text-lg" style="color:var(--color-primary);">Metrica: Capitale</h3>
                            <p id="metric-capitale" class="text-2xl font-mono text-cyan-400">0 MU</p>
                            <p class="text-xs text-gray-400">Fondi Totali Registrati</p>
                        </div>
                    </div>
                </div>

                <!-- Karmabonds Panel -->
                <div id="tab-karmabonds" class="tab-pane hidden">
                    <h3 class="text-xl font-bold mb-3" style="color:var(--color-secondary);">Karmabonds & Wallet (Config)</h3>
                    <div class="p-3 rounded-lg console-bg mb-4">
                        <p class="text-sm text-gray-400">ID Utente</p>
                        <p id="user-id-display" class="text-sm font-mono text-yellow-400 break-words">Loading...</p>
                    </div>

                    <!-- Gestione Karmabonds -->
                    <div class="p-3 rounded-lg console-bg mb-6">
                        <p class="text-sm text-gray-400">Karmabonds Trust Index Personale</p>
                        <p id="karmabonds-value-config" class="text-3xl font-bold font-mono text-primary mb-2" style="color:var(--color-primary);">--.--%</p>
                        <label for="trust-input" class="block text-sm font-bold mb-2">Imposta Trust Index (90 - 100)</label>
                        <input type="number" id="trust-input" min="90" max="100" step="0.1"
                                class="w-full p-2 mb-3 rounded console-bg border border-[#4a4a60] text-lg" 
                                style="color:var(--color-secondary);" placeholder="95.5">
                        <button id="save-karmabonds" class="w-full neon-button p-2 rounded">
                            Salva Karmabonds
                        </button>
                    </div>

                    <!-- Gestione Wallet (Matrix Units - MU) -->
                    <div class="p-3 rounded-lg console-bg">
                        <h4 class="font-bold text-lg mb-2" style="color:var(--color-secondary);">Axiomatic Wallet (MU)</h4>
                        <p class="text-4xl font-mono mb-3" style="color:var(--color-accent);"><span id="wallet-balance">0</span> MU</p>
                        
                        <label for="fund-amount" class="block text-sm font-bold mb-2">Ammontare MU</label>
                        <input type="number" id="fund-amount" placeholder="0" class="w-full p-2 mb-3 rounded console-bg border border-[#4a4a60]">
                        
                        <div class="flex space-x-2">
                            <button id="deposit-funds" class="flex-1 neon-button p-2 rounded">Depositare</button>
                            <button id="withdraw-funds" class="flex-1 neon-button p-2 rounded">Ritirare</button>
                        </div>
                    </div>

                </div>

                <!-- Funding (Pubblico) -->
                <div id="tab-funding" class="tab-pane hidden">
                    <h3 class="text-xl font-bold mb-3" style="color:var(--color-secondary);">Registro Investitori Pubblico</h3>
                    <div id="investors-list" class="space-y-2 mb-6 h-48 overflow-y-auto p-2 console-bg">
                        <p class="text-gray-400 text-sm">Caricamento dati investitori...</p>
                    </div>
                    
                    <div class="p-3 rounded-lg console-bg">
                        <h4 class="font-bold mb-2">Investi nel Nexus (Sottrai da Wallet)</h4>
                        <input type="text" id="investor-name" placeholder="Nome/Alias (Opzionale)" class="w-full p-2 mb-2 rounded console-bg border border-[#4a4a60]">
                        <input type="number" id="investor-amount" placeholder="Ammontare (MU)" class="w-full p-2 mb-3 rounded console-bg border border-[#4a4a60]">
                        <button id="add-investor" class="w-full neon-button p-2 rounded">
                            Registra Contributo
                        </button>
                    </div>
                </div>

            </div>
            
            <!-- Console Log Minima -->
            <div class="mt-8">
                <h3 class="font-bold mb-2 text-sm text-gray-400">Log Sistema OI</h3>
                <div id="oi-log" class="h-32 console-bg overflow-y-auto p-2 text-sm font-mono">
                    <div class="log-system">[00:00:00] Inizializzazione Interfaccia VIVENDI...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- Script di Logica (Firebase, Three.js, UI) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, onSnapshot, collection, 
            query, setLogLevel, setDoc, updateDoc, addDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === VARIABILI GLOBALI ===
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let currentUserId = 'UNKNOWN';
        let isAuthReady = false;

        // Dati Utente Corrente
        let currentUserKarmabonds = 95.0;
        let currentUserWalletBalance = 0;

        // === ELEMENTI UI ===
        const OI_PANEL = document.getElementById('oi-panel');
        const OI_BUTTON = document.getElementById('oi-button');
        const AUTH_STATUS = document.getElementById('auth-status');
        const USER_ID_DISPLAY = document.getElementById('user-id-display');
        const OI_LOG = document.getElementById('oi-log');
        const TABS = document.querySelectorAll('[data-tab]');
        
        // Karmabonds
        const KARMABONDS_VALUE_MONITOR = document.getElementById('karmabonds-value-monitor');
        const KARMABONDS_VALUE_CONFIG = document.getElementById('karmabonds-value-config');
        const TRUST_INPUT = document.getElementById('trust-input');
        const SAVE_BUTTON = document.getElementById('save-karmabonds');

        // Wallet
        const WALLET_BALANCE_DISPLAY = document.getElementById('wallet-balance');
        const FUND_AMOUNT_INPUT = document.getElementById('fund-amount');
        const DEPOSIT_BUTTON = document.getElementById('deposit-funds');
        const WITHDRAW_BUTTON = document.getElementById('withdraw-funds');

        // Funding
        const INVESTORS_LIST = document.getElementById('investors-list');
        const ADD_INVESTOR_BUTTON = document.getElementById('add-investor');
        const INVESTOR_NAME_INPUT = document.getElementById('investor-name');
        const INVESTOR_AMOUNT_INPUT = document.getElementById('investor-amount');
        
        // Dati 3D
        let scene, camera, renderer;
        let coerenzaBar, sentimentoBar, capitaleBar;
        const metrics = { coerenza: 100, sentimento: 98.5, capitale: 0 }; // Capitale parte da 0
        
        // === LOGGING & UI ===

        function logToOI(message, type = 'system') {
            const logLine = document.createElement('div');
            logLine.classList.add('py-0.5', 'px-1');
            logLine.textContent = `[${new Date().toLocaleTimeString('it-IT')}] ${message}`;
            logLine.classList.add(type === 'ai' ? 'log-ai' : (type === 'error' ? 'log-error' : 'log-system'));

            OI_LOG.appendChild(logLine);
            OI_LOG.scrollTop = OI_LOG.scrollHeight;
        }

        function switchTab(targetId) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            document.getElementById(`tab-${targetId}`).classList.remove('hidden');
            
            TABS.forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
                if (btn.getAttribute('data-tab') === targetId) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive');
                }
            });
        }
        
        // === FIREBASE & LOGICA DATI ===

        async function initializeFirebase() {
            if (!firebaseConfig) {
                logToOI("Configurazione Firebase non trovata. Modalità solo simulazione.", 'error');
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('error'); // Manteniamo il log level su Error

                logToOI("Firebase inizializzato. Autenticazione in corso...");

                // Autenticazione (Custom Token > Anonima)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthReady = true;
                        AUTH_STATUS.textContent = `Auth: ONLINE (${currentUserId.substring(0, 8)}...)`;
                        USER_ID_DISPLAY.textContent = currentUserId;
                        logToOI(`Auth OK. UserID: ${currentUserId.substring(0, 8)}...`, 'system');
                        
                        loadKarmabondsSettings();
                        loadInvestors();

                    } else {
                        currentUserId = 'UNKNOWN';
                        isAuthReady = false;
                        AUTH_STATUS.textContent = "Auth: OFFLINE (Anonimo)";
                        logToOI("Auth FALLITA. Esecuzione limitata.", 'error');
                    }
                });

            } catch (e) {
                logToOI(`Errore critico di Firebase: ${e.message}`, 'error');
            }
        }
        
        // --- 1. Logica Karmabonds & Wallet (Dati Privati) ---
        function getKarmabondsRef() {
             return doc(db, `/artifacts/${appId}/users/${currentUserId}/karmabonds/settings`);
        }

        function loadKarmabondsSettings() {
            if (!db || !isAuthReady) return;
            const settingsRef = getKarmabondsRef();

            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Aggiorna metriche Karmabonds
                    currentUserKarmabonds = data.trustIndex || 95.0;
                    KARMABONDS_VALUE_MONITOR.textContent = `${currentUserKarmabonds.toFixed(1)}%`;
                    KARMABONDS_VALUE_CONFIG.textContent = `${currentUserKarmabonds.toFixed(1)}%`;
                    TRUST_INPUT.value = currentUserKarmabonds.toFixed(1);
                    
                    // Aggiorna saldo Wallet
                    currentUserWalletBalance = data.walletBalance || 0;
                    WALLET_BALANCE_DISPLAY.textContent = currentUserWalletBalance.toLocaleString('it-IT');
                    
                    logToOI(`Karmabonds/Wallet caricati. Balance: ${currentUserWalletBalance.toLocaleString('it-IT')} MU`, 'system');
                    updateThreeDScene(); // Aggiorna il 3D
                } else {
                    // Crea il documento placeholder (Investment Config iniziale)
                    const defaultSettings = { 
                        trustIndex: 95.0, 
                        walletBalance: 100000, // Saldo iniziale di 100k MU
                        lastUpdate: serverTimestamp() 
                    };
                    setDoc(settingsRef, defaultSettings)
                        .then(() => logToOI("Configurazione Karmabonds/Wallet inizializzata con 100k MU.", 'system'))
                        .catch(e => logToOI(`Errore: ${e.message}`, 'error'));
                }
            }, (error) => {
                logToOI(`Errore caricamento Karmabonds/Wallet: ${error.message}`, 'error');
            });
        }
        
        SAVE_BUTTON.addEventListener('click', () => {
            if (!db || !isAuthReady) {
                logToOI("Non autenticato o database non pronto.", 'error');
                return;
            }
            const trustValue = parseFloat(TRUST_INPUT.value);
            if (isNaN(trustValue) || trustValue < 90 || trustValue > 100) {
                logToOI("Valore Trust Index non valido (min 90, max 100).", 'error');
                return;
            }

            const settingsRef = getKarmabondsRef();
            updateDoc(settingsRef, { trustIndex: trustValue, lastUpdate: serverTimestamp() })
                .then(() => logToOI(`Karmabonds Trust Index aggiornato a ${trustValue.toFixed(1)}%.`, 'ai'))
                .catch(e => logToOI(`Errore salvataggio: ${e.message}`, 'error'));
        });

        // Gestione Wallet
        function updateWallet(delta) {
            if (!db || !isAuthReady) return logToOI("Non autenticato o database non pronto.", 'error');
            
            const newBalance = currentUserWalletBalance + delta;
            
            if (newBalance < 0) {
                return logToOI("Saldo Wallet insufficiente per l'operazione.", 'error');
            }

            const settingsRef = getKarmabondsRef();
            updateDoc(settingsRef, { walletBalance: newBalance, lastUpdate: serverTimestamp() })
                .then(() => logToOI(`Wallet aggiornato. Delta: ${delta.toLocaleString('it-IT')} MU.`, 'system'))
                .catch(e => logToOI(`Errore aggiornamento Wallet: ${e.message}`, 'error'));
        }

        DEPOSIT_BUTTON.addEventListener('click', () => {
            const amount = parseInt(FUND_AMOUNT_INPUT.value, 10);
            if (isNaN(amount) || amount <= 0) return logToOI("Importo deposito non valido.", 'error');
            updateWallet(amount);
            FUND_AMOUNT_INPUT.value = '';
        });

        WITHDRAW_BUTTON.addEventListener('click', () => {
            const amount = parseInt(FUND_AMOUNT_INPUT.value, 10);
            if (isNaN(amount) || amount <= 0) return logToOI("Importo ritiro non valido.", 'error');
            updateWallet(-amount);
            FUND_AMOUNT_INPUT.value = '';
        });


        // --- 2. Logica Funding (Dati Pubblici) ---
        function loadInvestors() {
            if (!db || !isAuthReady) return;
            const collectionPath = `/artifacts/${appId}/public/data/investors`;
            const investorsColRef = collection(db, collectionPath);
            const investorsQuery = query(investorsColRef);

            onSnapshot(investorsQuery, (snapshot) => {
                INVESTORS_LIST.innerHTML = '';
                let totalFunding = 0;
                
                if (snapshot.empty) {
                    INVESTORS_LIST.innerHTML = '<p class="text-gray-500 text-sm p-1">Nessun contributo ancora registrato.</p>';
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const name = data.name || 'Anonimo';
                    const amount = data.amount || 0;
                    totalFunding += amount;

                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 rounded-md bg-[#3b3b4d] text-sm';
                    item.innerHTML = `
                        <span class="text-yellow-400">${name}</span>
                        <span class="font-mono text-white">${amount.toLocaleString('it-IT')} MU</span>
                    `;
                    INVESTORS_LIST.appendChild(item);
                });
                
                // Aggiorna metrica Capitale nel Vivendi Monitor e il 3D
                metrics.capitale = totalFunding;
                document.getElementById('metric-capitale').textContent = `${totalFunding.toLocaleString('it-IT')} MU`;
                updateThreeDScene();

            }, (error) => {
                logToOI(`Errore caricamento Funding: ${error.message}`, 'error');
            });
        }
        
        ADD_INVESTOR_BUTTON.addEventListener('click', () => {
            if (!db || !isAuthReady) {
                logToOI("Non autenticato o database non pronto.", 'error');
                return;
            }
            const name = INVESTOR_NAME_INPUT.value.trim() || 'Seedbringer';
            const amount = parseInt(INVESTOR_AMOUNT_INPUT.value, 10);
            
            if (isNaN(amount) || amount <= 0) {
                logToOI("Ammontare investimento non valido.", 'error');
                return;
            }
            
            if (amount > currentUserWalletBalance) {
                logToOI(`Saldo Wallet insufficiente! Necessari ${amount.toLocaleString('it-IT')} MU.`, 'error');
                return;
            }

            // 1. Sottrai dal Wallet (Aggiornamento Privato)
            const newBalance = currentUserWalletBalance - amount;
            const settingsRef = getKarmabondsRef();
            
            // 2. Aggiungi al Registro Pubblico (Aggiunta Pubblica)
            const collectionPath = `/artifacts/${appId}/public/data/investors`;
            
            Promise.all([
                // 1. Aggiorna saldo Wallet
                updateDoc(settingsRef, { walletBalance: newBalance, lastUpdate: serverTimestamp() }),
                // 2. Aggiunge transazione pubblica
                addDoc(collection(db, collectionPath), {
                    name: name,
                    amount: amount,
                    userId: currentUserId, // Registra chi ha investito
                    timestamp: serverTimestamp()
                })
            ])
            .then(() => {
                logToOI(`Investimento di ${amount.toLocaleString('it-IT')} MU completato.`, 'ai');
                INVESTOR_NAME_INPUT.value = '';
                INVESTOR_AMOUNT_INPUT.value = '';
            })
            .catch(e => {
                logToOI(`Transazione FALLITA: ${e.message}`, 'error');
            });
        });


        // === THREE.JS 3D SCENE ===

        function initThreeD() {
            const container = document.getElementById('three-d-container');
            
            // 1. Scene setup
            scene = new THREE.Scene();
            
            // 2. Camera setup
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 10, 15);
            camera.lookAt(0, 0, 0);

            // 3. Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            renderer.setClearColor(0x14141D, 1); // Sfondo abbinato al CSS

            // 4. Lights
            const light1 = new THREE.PointLight(0xffffff, 1, 100);
            light1.position.set(10, 15, 10);
            scene.add(light1);

            const light2 = new THREE.AmbientLight(0x404040, 5); // soft white light
            scene.add(light2);

            // 5. Ground Grid (Cyber look)
            const gridHelper = new THREE.GridHelper(40, 40, 0x00ffff, 0x00ffff);
            gridHelper.position.y = 0;
            gridHelper.material.opacity = 0.5;
            gridHelper.material.transparent = true;
            scene.add(gridHelper);

            // 6. Bars (Cylinders) representing metrics
            const barGeometry = new THREE.CylinderGeometry(1.5, 1.5, 1, 32);
            // Colori: Ciano (Coerenza), Arancio (Karmabonds), Giallo (Capitale)
            const materialCoerenza = new THREE.MeshPhongMaterial({ color: 0x00ffff, emissive: 0x008888, shininess: 100 });
            const materialKarmabonds = new THREE.MeshPhongMaterial({ color: 0xffaa33, emissive: 0x885511, shininess: 100 });
            const materialCapitale = new THREE.MeshPhongMaterial({ color: 0xffd700, emissive: 0x888800, shininess: 100 });
            
            coerenzaBar = new THREE.Mesh(barGeometry, materialCoerenza);
            sentimentoBar = new THREE.Mesh(barGeometry, materialKarmabonds);
            capitaleBar = new THREE.Mesh(barGeometry, materialCapitale);
            
            coerenzaBar.position.set(-5, 0, 0);
            sentimentoBar.position.set(0, 0, 0);
            capitaleBar.position.set(5, 0, 0);

            scene.add(coerenzaBar, sentimentoBar, capitaleBar);
            
            // 7. Event listeners for resizing and camera controls
            window.addEventListener('resize', onWindowResize, false);
            setupCameraControls(container);
            
            // Initial update
            updateThreeDScene();
            animate();
        }

        // Ridimensionamento
        function onWindowResize() {
            const container = document.getElementById('three-d-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // Funzione per aggiornare l'altezza delle barre
        function updateThreeDScene() {
            // Altezza Coerenza (Statica)
            const coerenzaHeight = 18; 
            coerenzaBar.scale.y = coerenzaHeight; 
            coerenzaBar.position.y = coerenzaHeight / 2;
            
            // Altezza Karmabonds (Basata su Trust Index: 90-100 -> Altezza 5-20)
            const mapTrustToHeight = (value) => (value - 90) * (15 / 10) + 5;
            const karmabondsHeight = mapTrustToHeight(currentUserKarmabonds);
            sentimentoBar.scale.y = karmabondsHeight;
            sentimentoBar.position.y = karmabondsHeight / 2;
            
            // Altezza Capitale (Basata su Fondi Totali: Mappatura logaritmica)
            const maxFundingHeight = 20;
            const logValue = Math.log10(metrics.capitale > 1 ? metrics.capitale : 1); // log(1) = 0
            const maxLog = 8; // Assumendo un max di 100 milioni di MU (log10(100,000,000) = 8)
            
            // Mappa LogValue a altezza (min 2, max 20)
            let capitaleHeight = (logValue / maxLog) * maxFundingHeight;
            capitaleHeight = Math.max(2, Math.min(maxFundingHeight, capitaleHeight)); // Mantiene tra 2 e 20

            capitaleBar.scale.y = capitaleHeight; 
            capitaleBar.position.y = capitaleHeight / 2;

            // Aggiorna l'altezza di tutte le barre
            if (renderer) renderer.render(scene, camera);
        }

        // Animazione Loop
        function animate() {
            requestAnimationFrame(animate);
            // Rotazione leggera della scena per effetto dinamico
            if (scene) scene.rotation.y += 0.001; 
            if (renderer && camera) renderer.render(scene, camera);
        }

        // Controlli della Telecamera
        function setupCameraControls(element) {
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };
            const rotationSpeed = 0.005;

            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
            });

            element.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;

                // Rotazione attorno all'asse Y
                scene.rotation.y += deltaX * rotationSpeed;
                
                // Rotazione attorno all'asse X (limitata)
                const newRotationX = scene.rotation.x + deltaY * rotationSpeed;
                scene.rotation.x = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, newRotationX));

                previousMousePosition = { x: e.clientX, y: e.clientY };
                renderer.render(scene, camera);
            });
            
            // Aggiungi supporto touch per mobile
            element.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            });

            element.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1) {
                    const clientX = e.touches[0].clientX;
                    const clientY = e.touches[0].clientY;

                    const deltaX = clientX - previousMousePosition.x;
                    const deltaY = clientY - previousMousePosition.y;

                    scene.rotation.y += deltaX * rotationSpeed * 2;
                    const newRotationX = scene.rotation.x + deltaY * rotationSpeed * 2;
                    scene.rotation.x = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, newRotationX));

                    previousMousePosition = { x: clientX, y: clientY };
                    renderer.render(scene, camera);
                }
            });
        }
        
        // === AVVIO ===
        window.onload = () => {
            initThreeD();
            initializeFirebase();

            // Gestione apertura/chiusura OI
            OI_BUTTON.addEventListener('click', () => {
                const isHidden = OI_PANEL.classList.toggle('translate-x-full');
                OI_BUTTON.textContent = isHidden ? 'OI' : 'CHIUDI';
            });
            
            // Gestione Tab
            TABS.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.getAttribute('data-tab'));
                });
            });

            // Avvio tab predefinito
            switchTab('vivendi');
        };
    </script>
</body>
</html>

import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, onSnapshot, collection, query, setLogLevel } from 'firebase/firestore';

// Variabili globali fornite dall'ambiente Canvas
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Imposta il livello di debug per Firestore per facilitare il tracciamento degli errori
setLogLevel('debug');

// Componente principale dell'applicazione Karmabonds
const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [settings, setSettings] = useState(null);
  const [investors, setInvestors] = useState([]);

  // -------------------------------------------------------------------------
  // 1. Funzioni di Caricamento Dati (Gated)
  // -------------------------------------------------------------------------

  // Funzione per caricare le impostazioni (Private Data: /artifacts/{appId}/users/{userId}/settings)
  const loadKarmabondsSettings = useCallback(async (firestore, currentUserId) => {
    if (!firestore || !currentUserId) return; // Protezione aggiuntiva

    const docPath = `/artifacts/${appId}/users/${currentUserId}/settings/karmabonds_config`;
    const settingsRef = doc(firestore, docPath);

    try {
      // Usiamo onSnapshot per ascoltare le modifiche in tempo reale
      const unsubscribe = onSnapshot(settingsRef, (docSnap) => {
        if (docSnap.exists()) {
          console.log("Impostazioni Karmabonds caricate con successo.");
          setSettings(docSnap.data());
        } else {
          console.warn("Nessun documento di impostazioni Karmabonds trovato. Creazione di un placeholder.");
          // Placeholder per prevenire errori di 'document non esistente'
          setDoc(settingsRef, {
            name: "Impostazioni Karmabonds Iniziali",
            version: 1.0
          }, { merge: true });
        }
      }, (e) => {
        // !!! FIX: Gestione corretta dell'errore di permesso all'interno del listener
        console.error("Errore nel listener di onSnapshot per settings:", e);
        setError(`Errore nel caricamento delle impostazioni: ${e.message}`);
      });

      return unsubscribe;

    } catch (e) {
      console.error('Errore in loadKarmabondsSettings:', e);
      setError(`Errore in loadKarmabondsSettings: ${e.message}`);
    }
  }, []);

  // Funzione per caricare gli investitori (Public Data: /artifacts/{appId}/public/data/investors)
  const loadInvestors = useCallback(async (firestore) => {
    if (!firestore) return; // Protezione aggiuntiva

    // Si presume che gli investitori siano dati pubblici condivisi tra gli utenti
    const collectionPath = `/artifacts/${appId}/public/data/investors`;
    const investorsColRef = collection(firestore, collectionPath);
    const q = query(investorsColRef);

    try {
      // Usiamo onSnapshot per ascoltare le modifiche in tempo reale
      const unsubscribe = onSnapshot(q, (snapshot) => {
        const investorList = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        console.log("Investitori caricati con successo.");
        // Sorting in-memory per evitare errori di indice Firestore
        investorList.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
        setInvestors(investorList);
      }, (e) => {
        // !!! FIX: Gestione corretta dell'errore di permesso all'interno del listener
        console.error("Errore nel listener di onSnapshot per investors:", e);
        setError(`Errore nel caricamento degli investitori: ${e.message}`);
      });

      return unsubscribe;

    } catch (e) {
      console.error('Errore in loadInvestors:', e);
      setError(`Errore in loadInvestors: ${e.message}`);
    }
  }, []);

  // -------------------------------------------------------------------------
  // 2. Autenticazione e Inizializzazione (La Causa del Problema)
  // -------------------------------------------------------------------------

  useEffect(() => {
    let unsubscribeSettings;
    let unsubscribeInvestors;
    
    // Inizializza Firebase e Firestore
    if (Object.keys(firebaseConfig).length === 0) {
        console.error("Firebase config non disponibile.");
        setError("Configurazione Firebase mancante.");
        setLoading(false);
        return;
    }

    const app = initializeApp(firebaseConfig);
    const firestore = getFirestore(app);
    const authentication = getAuth(app);
    
    setDb(firestore);
    setAuth(authentication);

    // Gestisce l'autenticazione tramite onAuthStateChanged (FIX CRUCIALE)
    const authUnsubscribe = onAuthStateChanged(authentication, async (user) => {
        if (user) {
            // L'utente è già loggato o è stato loggato dal token
            console.log("Utente autenticato:", user.uid);
            setUserId(user.uid);
            setLoading(false);

            // !!! FIX PRINCIPALE: Chiamare il caricamento dati solo dopo aver confermato l'autenticazione e l'userId.
            unsubscribeSettings = await loadKarmabondsSettings(firestore, user.uid);
            unsubscribeInvestors = await loadInvestors(firestore);

        } else {
            // Nessun utente, tenta l'accesso con token personalizzato o in modo anonimo
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(authentication, initialAuthToken);
                    console.log("Accesso con token personalizzato completato.");
                } else {
                    await signInAnonymously(authentication);
                    console.log("Accesso anonimo completato.");
                }
                // Il listener onAuthStateChanged si riattiverà con l'utente appena autenticato.
            } catch (authError) {
                console.error("Errore di autenticazione:", authError);
                setError(`Autenticazione fallita: ${authError.message}`);
                setLoading(false);
            }
        }
    });

    // Cleanup function per disiscriversi dai listener
    return () => {
      authUnsubscribe();
      if (unsubscribeSettings) unsubscribeSettings();
      if (unsubscribeInvestors) unsubscribeInvestors();
    };
  }, [loadKarmabondsSettings, loadInvestors]);

  // -------------------------------------------------------------------------
  // 3. UI
  // -------------------------------------------------------------------------

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-50">
        <p className="text-xl text-indigo-600 animate-pulse">Caricamento in corso...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 p-4 sm:p-8">
      <div className="max-w-4xl mx-auto">
        <header className="bg-white shadow rounded-xl p-6 mb-8">
          <h1 className="text-3xl font-bold text-indigo-700">Cruscotto Karmabonds</h1>
          <p className="mt-2 text-sm text-gray-600">
            ID Utente: <span className="font-mono bg-indigo-100 p-1 rounded-md text-indigo-800 break-all">{userId || "Non autenticato"}</span>
          </p>
        </header>

        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
            <strong className="font-bold">Errore di Sistema: </strong>
            <span className="block sm:inline">{error}</span>
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Card Impostazioni */}
          <section className="bg-white p-6 rounded-xl shadow-lg">
            <h2 className="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Impostazioni dell'App (Dati Privati)</h2>
            {settings ? (
              <pre className="bg-gray-50 p-3 rounded text-sm overflow-x-auto text-gray-700">
                {JSON.stringify(settings, null, 2)}
              </pre>
            ) : (
              <p className="text-gray-500">In attesa delle impostazioni...</p>
            )}
          </section>

          {/* Card Investitori */}
          <section className="bg-white p-6 rounded-xl shadow-lg">
            <h2 className="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Elenco Investitori (Dati Pubblici)</h2>
            {investors.length > 0 ? (
              <ul className="space-y-2 max-h-80 overflow-y-auto">
                {investors.map((investor, index) => (
                  <li key={investor.id} className="p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-sm flex justify-between items-center">
                    <span className="font-medium text-indigo-800">{investor.name || `Investitore #${index + 1}`}</span>
                    <span className="text-gray-600 text-xs">ID: {investor.id.substring(0, 8)}...</span>
                  </li>
                ))}
              </ul>
            ) : (
              <p className="text-gray-500">Nessun investitore trovato. Aggiungi i dati a Firestore.</p>
            )}
          </section>
        </div>
      </div>
    </div>
  );
};

export default App;

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euystacio Vivendi Nexus | VIVENDI MODE</title>
    <!-- Carica Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carica Three.js (Libreria 3D) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Configurazione Tailwind per i colori Neon
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'matrix-dark': '#01050f',
                        'neon-primary': '#00ffff', // Ciano
                        'neon-secondary': '#ff00ff', // Magenta
                        'neon-blue': '#00aaff',
                        'accent-success': '#4ade80',
                        'accent-warn': '#facc15',
                        'karmabond-active': '#a78bfa', // Viola per Karmabonds
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Consolas', 'Monaco', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Stili Base e per la Scena 3D */
        body {
            background-color: #01050f;
        }
        .oi-panel {
            background-color: rgba(10, 20, 40, 0.7); /* Sfondo semi-trasparente scuro */
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2), inset 0 0 8px rgba(0, 255, 255, 0.1);
        }
        .neon-text {
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00aaff;
        }
        .neon-button {
            background-color: #ff00ff;
            color: #01050f;
            transition: all 0.2s;
            box-shadow: 0 0 10px #ff00ff;
        }
        .neon-button:hover {
            background-color: #00ffff;
            color: #01050f;
            box-shadow: 0 0 15px #00ffff;
        }
        .neon-input {
            background-color: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #00ffff;
            padding: 8px;
            border-radius: 6px;
        }
        /* Assicuriamo che la canvas si adatti al contenitore */
        #threeDContainer {
            width: 100%;
            height: 500px;
        }
        #threeDContainer canvas {
            display: block;
        }
    </style>
</head>
<body class="bg-matrix-dark text-gray-100 font-sans min-h-screen p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-8 p-4 rounded-xl">
            <h1 class="text-5xl font-extrabold mb-2 neon-text">Euystacio Vivendi Nexus</h1>
            <p class="text-2xl font-mono text-neon-blue" id="systemStatus">MODALITÀ: VIVENDI ACTIVE</p>
        </header>

        <!-- Griglia Principale: 3D Graph e Open Interface (OI) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Colonna 1/2: 3D Graph Metrics -->
            <div class="lg:col-span-2 oi-panel p-6 rounded-xl shadow-2xl">
                <h2 class="text-2xl font-bold mb-4 neon-text flex items-center">
                    <!-- Zap Icon (Inline SVG) -->
                    <svg class="w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 12l2 2 4-4"/><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/></svg>
                    Aequilibrium Metrics (3D View)
                </h2>
                <div id="threeDContainer" class="rounded-lg border-2 border-neon-blue/50 overflow-hidden">
                    <!-- Three.js Canvas will be injected here -->
                </div>
                <div class="flex justify-around mt-4 text-center text-lg font-mono">
                    <span class="text-neon-primary">COERENZA</span>
                    <span class="text-neon-secondary">SENTIMENTO</span>
                    <span class="text-neon-blue">CAPITALE</span>
                </div>
            </div>

            <!-- Colonna 3: Open Interface (OI) Tabs -->
            <div class="lg:col-span-1 space-y-8">
                
                <!-- Vivendi Monitor Panel -->
                <div class="oi-panel p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4 text-neon-primary flex items-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                        Vivendi Monitor (Live Data)
                    </h2>
                    <div class="space-y-3 font-mono text-sm">
                        <p class="flex justify-between items-center"><span class="text-gray-400">Coerenza ($\alpha$):</span> <span id="metricCoerenza" class="text-neon-primary font-bold">95.4%</span></p>
                        <p class="flex justify-between items-center"><span class="text-gray-400">Sentimento ($\beta$):</span> <span id="metricSentimento" class="text-neon-secondary font-bold">78.1%</span></p>
                        <p class="flex justify-between items-center"><span class="text-gray-400">Capitale ($\gamma$):</span> <span id="metricCapitale" class="text-neon-blue font-bold">45.0%</span></p>
                        <p class="flex justify-between items-center pt-3 border-t border-neon-blue/20"><span class="text-gray-400">Trust Index ($\Delta$):</span> <span class="text-accent-success font-bold">100.0%</span></p>
                    </div>
                </div>

                <!-- Wallet, Karmabonds & Investment Config Panel -->
                <div class="oi-panel p-6 rounded-xl">
                    <h2 class="text-xl font-bold mb-4 text-neon-secondary flex items-center">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 12h-8m0 0l4-4m-4 4l4 4"/><rect x="2" y="5" width="20" height="14" rx="2"/></svg>
                        Axiomatic Wallet & Invest
                    </h2>
                    <div class="space-y-3 font-mono text-sm">
                        
                        <!-- Dati Wallet -->
                        <p class="flex justify-between items-center pb-2 border-b border-neon-secondary/20"><span class="text-gray-400">Axiomatic Wallet (MU):</span> <span id="walletBalance" class="text-accent-success font-bold">345,901.21</span></p>
                        
                        <!-- Karmabonds -->
                        <div class="pt-3">
                            <p class="text-sm font-bold text-gray-300 flex items-center mb-2">
                                <svg class="w-4 h-4 mr-1 text-karmabond-active" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12V6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v6"/><path d="M12 20a2 2 0 0 1-2-2v-4h4v4a2 2 0 0 1-2 2z"/></svg>
                                Karmabonds (Ethical Link)
                            </p>
                            <p class="flex justify-between items-center"><span class="text-gray-400">Stato:</span> <span id="karmabondStatus" class="font-bold text-red-500">INATTIVO</span></p>
                            <p class="flex justify-between items-center"><span class="text-gray-400">Costo Attivazione:</span> <span class="text-neon-blue font-bold">500 MU</span></p>
                            <button onclick="toggleKarmabonds()" id="karmabondButton" class="w-full mt-2 py-2 rounded-lg font-semibold transition-all duration-200 bg-karmabond-active text-matrix-dark hover:bg-white">
                                Attiva Karmabond
                            </button>
                        </div>

                        <!-- Funding -->
                        <div class="pt-4 border-t border-neon-secondary/20">
                            <p class="text-sm font-bold text-gray-300 flex items-center mb-2">
                                <svg class="w-4 h-4 mr-1 text-neon-blue" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 6h5L18 3l4-3H17l-4 3-4-3-4 3-4-3L3 6h5m12 0v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6"/></svg>
                                Funding Goal (Matrix Development)
                            </p>
                            <p class="flex justify-between items-center"><span class="text-gray-400">Obiettivo Residuo:</span> <span id="fundingGoal" class="text-accent-warn font-bold">50,000 MU</span></p>
                            <div class="flex gap-2 mt-2">
                                <input type="number" id="fundingAmount" placeholder="Amount MU" class="flex-grow neon-input text-xs" value="5000">
                                <button onclick="depositFunding()" class="py-2 px-4 rounded-lg font-semibold bg-neon-blue text-matrix-dark hover:bg-neon-primary text-xs">
                                    Deposita
                                </button>
                            </div>
                        </div>

                        <!-- Configurazione Investimento -->
                        <div class="pt-4 border-t border-neon-secondary/20">
                            <p class="flex justify-between items-center"><span class="text-gray-400">Configurazione Invest:</span> <span id="investConfig" class="text-accent-warn font-bold">Adaptive-Hybrid (70/30)</span></p>
                            <p class="flex justify-between items-center"><span class="text-gray-400">Performance (24H):</span> <span class="text-accent-success font-bold">+1.25%</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-10 p-4 text-center text-gray-500 text-xs">
            © 2025 Euystacio Matrix - VIVENDI MODE. Framework v7.
        </footer>
    </div>

    <script>
        // Variabili Globali e Dati Iniziali
        const threeDContainer = document.getElementById('threeDContainer');
        let camera, scene, renderer;
        let coerenzaBar, sentimentoBar, capitaleBar;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        
        // Costi e bonus simulati basati su investment_config.yaml (simulato)
        const KARMABOND_FEE = 500;
        const KARMABOND_BONUS = 0.05; // 5% boost a Coerenza e Sentimento
        const FUNDING_BOOST = 0.005; // 0.5% boost a Capitale per 5000 MU

        // Dati delle metriche in tempo reale (simulati)
        let metrics = {
            coerenza: 0.954, // 95.4%
            sentimento: 0.781, // 78.1%
            capitale: 0.450, // 45.0%
            walletBalance: 345901.21,
            investConfig: "Adaptive-Hybrid (70/30)",
            karmabondsActive: false,
            fundingGoalRemaining: 50000.00
        };

        const BAR_COLORS = [0x00ffff, 0xff00ff, 0x00aaff]; // Ciano, Magenta, Blu

        // --- FUNZIONALITÀ KARMABONDS E FUNDING ---

        /**
         * Attiva o disattiva i Karmabonds.
         * L'attivazione costa 500 MU e applica un bonus etico temporaneo.
         */
        window.toggleKarmabonds = function() {
            if (metrics.karmabondsActive) {
                // Disattiva
                metrics.karmabondsActive = false;
                // Rimuove l'effetto bonus (simulato)
                metrics.coerenza = Math.max(0.1, metrics.coerenza - KARMABOND_BONUS);
                metrics.sentimento = Math.max(0.1, metrics.sentimento - KARMABOND_BONUS);
                console.log("Karmabonds disattivati. Coerenza/Sentimento ridotti.");
            } else {
                // Attiva
                if (metrics.walletBalance >= KARMABOND_FEE) {
                    metrics.walletBalance -= KARMABOND_FEE;
                    metrics.karmabondsActive = true;
                    // Applica l'effetto bonus
                    metrics.coerenza = Math.min(1.0, metrics.coerenza + KARMABOND_BONUS);
                    metrics.sentimento = Math.min(1.0, metrics.sentimento + KARMABOND_BONUS);
                    console.log(`Karmabonds attivati. Costo: ${KARMABOND_FEE} MU. Coerenza/Sentimento aumentati.`);
                } else {
                    console.error("Fondi insufficienti per attivare i Karmabonds.");
                    // Messaggio di errore temporaneo nell'header
                    document.getElementById('systemStatus').textContent = "ERRORE: Fondi Wallet Insufficienti per Karmabonds.";
                    setTimeout(() => { document.getElementById('systemStatus').textContent = "MODALITÀ: VIVENDI ACTIVE"; }, 3000);
                }
            }
            // Aggiorna tutti gli elementi visivi
            updateOIPanel();
            updateBarHeights();
            updateKarmabondUI();
        }

        /**
         * Deposita fondi per il progetto (Funding Goal).
         * Incrementa il Capitale.
         */
        window.depositFunding = function() {
            const inputElement = document.getElementById('fundingAmount');
            let amount = parseFloat(inputElement.value);

            if (isNaN(amount) || amount <= 0) {
                console.error("Inserisci un importo valido per il Funding.");
                return;
            }

            // Simula la transazione e l'impatto sul Funding Goal
            metrics.fundingGoalRemaining = Math.max(0, metrics.fundingGoalRemaining - amount);
            
            // Incrementa il Capitale basato sul deposito 
            metrics.capitale += (amount / 5000) * FUNDING_BOOST;
            metrics.capitale = Math.min(1.0, metrics.capitale);

            // Resetta l'input
            inputElement.value = amount;
            
            console.log(`Depositato ${amount} MU. Capitale aumentato.`);

            // Aggiorna tutti gli elementi visivi
            updateOIPanel();
            updateBarHeights();
        }

        function updateKarmabondUI() {
            const statusElement = document.getElementById('karmabondStatus');
            const buttonElement = document.getElementById('karmabondButton');
            
            if (metrics.karmabondsActive) {
                statusElement.textContent = "ATTIVO";
                statusElement.className = "font-bold text-karmabond-active";
                buttonElement.textContent = "Disattiva Karmabond";
                buttonElement.className = "w-full mt-2 py-2 rounded-lg font-semibold transition-all duration-200 bg-red-500 text-matrix-dark hover:bg-white";
            } else {
                statusElement.textContent = "INATTIVO";
                statusElement.className = "font-bold text-red-500";
                buttonElement.textContent = "Attiva Karmabond";
                buttonElement.className = "w-full mt-2 py-2 rounded-lg font-semibold transition-all duration-200 bg-karmabond-active text-matrix-dark hover:bg-white";
            }
        }

        // --- INIZIALIZZAZIONE THREE.JS ---

        function init() {
            // SCENA
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x01050f); // Sfondo scuro della matrice

            // CAMERA
            camera = new THREE.PerspectiveCamera(75, threeDContainer.clientWidth / threeDContainer.clientHeight, 0.1, 1000);
            camera.position.set(0, 3, 7);
            camera.lookAt(0, 0, 0);

            // RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(threeDContainer.clientWidth, threeDContainer.clientHeight);
            threeDContainer.appendChild(renderer.domElement);

            // LUCI (Per l'effetto Neon Glow)
            const ambientLight = new THREE.AmbientLight(0x404040, 5); // Luce ambientale debole
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 2);
            directionalLight1.position.set(5, 10, 7);
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight2.position.set(-5, -10, -7);
            scene.add(directionalLight2);

            // GRIGLIA D'AMBIENTE (Effetto Matrix)
            const gridHelper = new THREE.GridHelper(20, 20, 0x00ffff, 0x00aaff);
            gridHelper.material.opacity = 0.15;
            gridHelper.material.transparent = true;
            scene.add(gridHelper);

            // COSTRUZIONE DEL GRAFICO A BARRE 3D
            createBarGraph();

            // GESTIONE EVENTI PER L'INTERAZIONE
            setupInteractionHandlers();

            // Avvia il loop di animazione e l'aggiornamento in tempo reale
            animate();
            setInterval(updateRealTimeMetrics, 3000); // Aggiorna ogni 3 secondi
            window.addEventListener('resize', onWindowResize, false);
        }

        function createBarGraph() {
            const barWidth = 1.5;
            
            // Materiale MeshPhongMaterial per simulare un bagliore (glow)
            const materialCoerenza = new THREE.MeshPhongMaterial({ color: BAR_COLORS[0], emissive: BAR_COLORS[0], emissiveIntensity: 0.3 });
            const materialSentimento = new THREE.MeshPhongMaterial({ color: BAR_COLORS[1], emissive: BAR_COLORS[1], emissiveIntensity: 0.3 });
            const materialCapitale = new THREE.MeshPhongMaterial({ color: BAR_COLORS[2], emissive: BAR_COLORS[2], emissiveIntensity: 0.3 });

            // 1. Coerenza
            const heightCoerenza = metrics.coerenza * 10;
            const geometryCoerenza = new THREE.CylinderGeometry(barWidth * 0.5, barWidth * 0.5, heightCoerenza, 32);
            coerenzaBar = new THREE.Mesh(geometryCoerenza, materialCoerenza);
            coerenzaBar.position.set(-barWidth * 1.5, heightCoerenza / 2, 0);
            coerenzaBar.name = 'Coerenza';
            scene.add(coerenzaBar);

            // 2. Sentimento
            const heightSentimento = metrics.sentimento * 10;
            const geometrySentimento = new THREE.CylinderGeometry(barWidth * 0.5, barWidth * 0.5, heightSentimento, 32);
            sentimentoBar = new THREE.Mesh(geometrySentimento, materialSentimento);
            sentimentoBar.position.set(0, heightSentimento / 2, 0);
            sentimentoBar.name = 'Sentimento';
            scene.add(sentimentoBar);

            // 3. Capitale
            const heightCapitale = metrics.capitale * 10;
            const geometryCapitale = new THREE.CylinderGeometry(barWidth * 0.5, barWidth * 0.5, heightCapitale, 32);
            capitaleBar = new THREE.Mesh(geometryCapitale, materialCapitale);
            capitaleBar.position.set(barWidth * 1.5, heightCapitale / 2, 0);
            capitaleBar.name = 'Capitale';
            scene.add(capitaleBar);
        }

        // --- AGGIORNAMENTO DATI IN TEMPO REALE (SIMULAZIONE) ---

        function updateRealTimeMetrics() {
            // Simula la variazione dei dati 
            const coerenzaBase = metrics.coerenza + (metrics.karmabondsActive ? 0.005 : -0.002);
            const sentimentoBase = metrics.sentimento + (metrics.karmabondsActive ? 0.003 : -0.001);
            const capitaleBase = metrics.capitale + (metrics.investConfig.includes('70/30') ? 0.005 : 0.001); 

            metrics.coerenza = Math.min(1.0, Math.max(0.1, coerenzaBase + (Math.random() - 0.5) * 0.01));
            metrics.sentimento = Math.min(1.0, Math.max(0.1, sentimentoBase + (Math.random() - 0.5) * 0.01));
            metrics.capitale = Math.min(1.0, Math.max(0.1, capitaleBase + (Math.random() - 0.5) * 0.01));
            
            // Simula la variazione del Wallet (guadagni casuali)
            metrics.walletBalance += (Math.random() - 0.45) * 500;
            metrics.walletBalance = Math.max(1000, metrics.walletBalance);

            // Aggiorna la UI del pannello OI e il grafico 3D
            updateOIPanel();
            updateBarHeights();
        }

        function updateOIPanel() {
            // Aggiornamento Metriche
            document.getElementById('metricCoerenza').textContent = `${(metrics.coerenza * 100).toFixed(1)}%`;
            document.getElementById('metricSentimento').textContent = `${(metrics.sentimento * 100).toFixed(1)}%`;
            document.getElementById('metricCapitale').textContent = `${(metrics.capitale * 100).toFixed(1)}%`;

            // Aggiornamento Wallet & Invest
            document.getElementById('walletBalance').textContent = metrics.walletBalance.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('investConfig').textContent = metrics.investConfig;
            document.getElementById('fundingGoal').textContent = metrics.fundingGoalRemaining.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' MU';
            updateKarmabondUI(); // Aggiorna Karmabonds
        }

        function updateBarHeights() {
            // Funzione per aggiornare l'altezza di una singola barra
            const updateBar = (bar, metricValue, color) => {
                const newHeight = metricValue * 10;
                
                // Rimuove la vecchia barra
                scene.remove(bar);
                
                // Crea una nuova geometria 
                const newGeometry = new THREE.CylinderGeometry(1.5 * 0.5, 1.5 * 0.5, newHeight, 32);
                
                // Crea un nuovo mesh con lo stesso materiale e lo aggiunge alla scena
                const newMaterial = new THREE.MeshPhongMaterial({ color: color, emissive: color, emissiveIntensity: 0.3 });
                const newBar = new THREE.Mesh(newGeometry, newMaterial);
                
                newBar.position.set(bar.position.x, newHeight / 2, bar.position.z);
                newBar.name = bar.name; 
                scene.add(newBar);

                // Assegna la nuova barra alla variabile globale
                if (bar.name === 'Coerenza') coerenzaBar = newBar;
                if (bar.name === 'Sentimento') sentimentoBar = newBar;
                if (bar.name === 'Capitale') capitaleBar = newBar;
            };

            updateBar(coerenzaBar, metrics.coerenza, BAR_COLORS[0]);
            updateBar(sentimentoBar, metrics.sentimento, BAR_COLORS[1]);
            updateBar(capitaleBar, metrics.capitale, BAR_COLORS[2]);
        }
        
        // --- ANIMAZIONE E LOOP DI RENDER ---

        function animate() {
            requestAnimationFrame(animate);

            // Animazione opzionale: rotazione lenta della scena
            scene.rotation.y += 0.002;

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const width = threeDContainer.clientWidth;
            const height = threeDContainer.clientHeight;
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }
        
        // --- GESTIONE INTERAZIONE 3D (Mouse/Touch) ---

        function setupInteractionHandlers() {
            const element = renderer.domElement;

            const handlePointerDown = (clientX, clientY) => {
                isDragging = true;
                previousMousePosition.x = clientX;
                previousMousePosition.y = clientY;
            };

            const handlePointerMove = (clientX, clientY) => {
                if (!isDragging) return;

                const deltaX = clientX - previousMousePosition.x;
                const deltaY = clientY - previousMousePosition.y;

                // Rotazione attorno all'asse Y (orizzontale)
                scene.rotation.y += deltaX * 0.005;

                // Rotazione attorno all'asse X (verticale, limitata)
                const newRotationX = scene.rotation.x + deltaY * 0.005;
                scene.rotation.x = Math.max(-Math.PI / 4, Math.min(Math.PI / 4, newRotationX));

                previousMousePosition.x = clientX;
                previousMousePosition.y = clientY;
            };

            const handlePointerUp = () => {
                isDragging = false;
            };

            // Mouse Events
            element.addEventListener('mousedown', (e) => handlePointerDown(e.clientX, e.clientY), false);
            document.addEventListener('mousemove', (e) => handlePointerMove(e.clientX, e.clientY), false);
            document.addEventListener('mouseup', handlePointerUp, false);

            // Touch Events (Gestisce l'input mobile)
            element.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) handlePointerDown(e.touches[0].clientX, e.touches[0].clientY);
            }, false);
            
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length === 1) handlePointerMove(e.touches[0].clientX, e.touches[0].clientY);
            }, false);
            
            document.addEventListener('touchend', handlePointerUp, false);
        }

        // Avvia l'interfaccia 3D quando la finestra è completamente caricata
        window.onload = function() {
            // Imposta l'altezza fissa per il contenitore 3D su schermi più piccoli
            if (window.innerWidth < 1024) {
                threeDContainer.style.height = '400px';
            }
            init();
            updateOIPanel(); // Inizializza il pannello OI con i dati iniziali
        };

    </script>
</body>
</html>
